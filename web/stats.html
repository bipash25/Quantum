<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Dashboard | Quantum Trading AI</title>
    <meta name="description" content="Real-time performance statistics for Quantum Trading AI signals. Track win rates, symbol performance, and trading history.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Dashboard-specific styles */
        .dashboard {
            padding: 100px 0 60px;
            min-height: 100vh;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .dashboard-header h1 {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .dashboard-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .last-updated {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 16px;
        }

        .last-updated .dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }

        .stat-card.highlight {
            border-color: var(--accent-primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, var(--bg-card) 100%);
        }

        .stat-card .label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-card .value.success { color: var(--success); }
        .stat-card .value.danger { color: var(--danger); }
        .stat-card .value.warning { color: #f59e0b; }

        .stat-card .sub {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Chart Section */
        .chart-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 40px;
        }

        .chart-section h2 {
            font-size: 18px;
            margin-bottom: 20px;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        /* Tables */
        .table-section {
            margin-bottom: 40px;
        }

        .table-section h2 {
            font-size: 18px;
            margin-bottom: 20px;
        }

        .data-table {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: var(--bg-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover td {
            background: var(--bg-secondary);
        }

        .data-table .symbol {
            font-weight: 600;
        }

        .data-table .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge.long {
            background: var(--success-bg);
            color: var(--success);
        }

        .badge.short {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .badge.active {
            background: rgba(99, 102, 241, 0.1);
            color: var(--accent-primary);
        }

        .badge.hit_tp {
            background: var(--success-bg);
            color: var(--success);
        }

        .badge.hit_sl {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .badge.expired {
            background: rgba(107, 112, 132, 0.2);
            color: var(--text-muted);
        }

        /* Win Rate Bar */
        .winrate-bar {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .winrate-bar .bar {
            flex: 1;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .winrate-bar .bar .fill {
            height: 100%;
            background: var(--success);
            border-radius: 4px;
        }

        .winrate-bar .percent {
            font-size: 12px;
            font-weight: 600;
            min-width: 40px;
            text-align: right;
        }

        /* Two column layout */
        .two-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 900px) {
            .two-columns {
                grid-template-columns: 1fr;
            }
        }

        /* Embed notice */
        .embed-notice {
            text-align: center;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-top: 40px;
        }

        .embed-notice code {
            display: block;
            background: var(--bg-primary);
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            font-size: 12px;
            color: var(--text-secondary);
            word-break: break-all;
        }

        /* Loading state */
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }

        .skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-card-hover) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        .skeleton-text {
            height: 20px;
            width: 60%;
            margin: 4px 0;
        }

        .skeleton-number {
            height: 40px;
            width: 80px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav container">
            <a href="/" class="logo">
                <span class="logo-icon">&#9889;</span>
                <span class="logo-text">Quantum<span class="highlight">AI</span></span>
            </a>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/stats" class="active">Stats</a>
                <a href="https://t.me/QuantumTradingAIX" target="_blank" class="btn btn-outline">Join Telegram</a>
            </div>
        </nav>
    </header>

    <main class="dashboard">
        <div class="container">
            <div class="dashboard-header">
                <h1>Performance Dashboard</h1>
                <p>Real-time trading signal performance statistics</p>
                <div class="last-updated">
                    <span class="dot"></span>
                    <span id="last-updated">Loading...</span>
                </div>
            </div>

            <!-- Main Stats -->
            <div class="stats-grid" id="stats-grid">
                <div class="stat-card highlight">
                    <div class="label">Cumulative P&L</div>
                    <div class="value" id="stat-pnl">--%</div>
                    <div class="sub">2% risk per trade</div>
                </div>
                <div class="stat-card highlight">
                    <div class="label">Total Signals</div>
                    <div class="value" id="stat-total">--</div>
                    <div class="sub" id="stat-breakdown">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="label">Win Rate</div>
                    <div class="value" id="stat-winrate">--%</div>
                    <div class="sub" id="stat-wins-losses">-- wins / -- losses</div>
                </div>
                <div class="stat-card">
                    <div class="label">Avg R:R Ratio</div>
                    <div class="value" id="stat-rr">--</div>
                    <div class="sub">Risk to Reward</div>
                </div>
                <div class="stat-card">
                    <div class="label">TP Hit Rates</div>
                    <div class="value" id="stat-tp-hits">--</div>
                    <div class="sub" id="stat-tp-breakdown">TP1 / TP2 / TP3</div>
                </div>
                <div class="stat-card">
                    <div class="label">Avg P&L/Trade</div>
                    <div class="value" id="stat-avg-pnl">--%</div>
                    <div class="sub">Per closed position</div>
                </div>
                <div class="stat-card">
                    <div class="label">4H Signals</div>
                    <div class="value" id="stat-4h">--</div>
                    <div class="sub">Swing trades</div>
                </div>
                <div class="stat-card">
                    <div class="label">24H Signals</div>
                    <div class="value" id="stat-24h">--</div>
                    <div class="sub">Position trades</div>
                </div>
            </div>

            <!-- Performance Chart -->
            <div class="chart-section">
                <h2>Daily Signal Performance (Last 30 Days)</h2>
                <div class="chart-container">
                    <canvas id="performance-chart"></canvas>
                </div>
            </div>

            <!-- Two Column Layout -->
            <div class="two-columns">
                <!-- Symbol Performance -->
                <div class="table-section">
                    <h2>Performance by Symbol</h2>
                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Signals</th>
                                    <th>Win Rate</th>
                                </tr>
                            </thead>
                            <tbody id="symbol-table">
                                <tr><td colspan="3" style="text-align: center; color: var(--text-muted);">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Recent Signals -->
                <div class="table-section">
                    <h2>Recent Signals (Last 10)</h2>
                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Direction</th>
                                    <th>Status</th>
                                    <th>R:R</th>
                                </tr>
                            </thead>
                            <tbody id="recent-table">
                                <tr><td colspan="4" style="text-align: center; color: var(--text-muted);">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Feature Importance Section -->
            <div class="chart-section" id="feature-section">
                <h2>Feature Importance (ML Model Insights)</h2>
                <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 20px;">
                    Features with the largest difference between winning and losing trades.
                    Higher importance score = more predictive of outcome.
                </p>
                <div class="chart-container" style="height: 250px;">
                    <canvas id="feature-chart"></canvas>
                </div>
            </div>

            <!-- Feature Details Tables -->
            <div class="two-columns">
                <!-- Feature Win/Loss Comparison -->
                <div class="table-section">
                    <h2>Feature Win/Loss Analysis</h2>
                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Feature</th>
                                    <th>Win Avg</th>
                                    <th>Loss Avg</th>
                                    <th>Win Rate</th>
                                </tr>
                            </thead>
                            <tbody id="feature-table">
                                <tr><td colspan="4" style="text-align: center; color: var(--text-muted);">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Feature Drift Alerts -->
                <div class="table-section">
                    <h2>Feature Drift Alerts</h2>
                    <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 12px;">
                        Features behaving differently in the last 7 days vs historical norms.
                    </p>
                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Feature</th>
                                    <th>Recent</th>
                                    <th>Historical</th>
                                    <th>Drift</th>
                                </tr>
                            </thead>
                            <tbody id="drift-table">
                                <tr><td colspan="4" style="text-align: center; color: var(--text-muted);">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Embed Notice -->
            <div class="embed-notice">
                <p style="color: var(--text-secondary); font-size: 14px;">
                    This dashboard is public and can be embedded on your website for transparency.
                </p>
                <code>&lt;iframe src="http://198.38.86.9/stats" width="100%" height="800" frameborder="0"&gt;&lt;/iframe&gt;</code>
            </div>

            <!-- Disclaimer -->
            <div class="footer-disclaimer" style="margin-top: 40px;">
                <p class="disclaimer-text">
                    <strong>DISCLAIMER:</strong> Past performance does not guarantee future results.
                    Trading involves substantial risk. These statistics are for informational purposes only.
                </p>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer" style="padding: 20px 0;">
        <div class="container">
            <div class="footer-bottom" style="padding-top: 0; border: none;">
                <p>&copy; 2026 Quantum Trading AI. Not financial advice.</p>
            </div>
        </div>
    </footer>

    <script>
        const API_BASE = 'http://198.38.86.9:8000';
        let performanceChart = null;
        let featureChart = null;

        // Format time ago
        function timeAgo(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' min ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
            return Math.floor(seconds / 86400) + ' days ago';
        }

        // Load main dashboard stats
        async function loadDashboardStats() {
            try {
                const response = await fetch(`${API_BASE}/public/dashboard`);
                const data = await response.json();

                // Cumulative P&L
                const pnlValue = data.cumulative_pnl || 0;
                document.getElementById('stat-pnl').textContent = (pnlValue >= 0 ? '+' : '') + pnlValue.toFixed(1) + '%';
                document.getElementById('stat-pnl').className = 'value ' + (pnlValue >= 0 ? 'success' : 'danger');

                document.getElementById('stat-total').textContent = data.total_signals;
                document.getElementById('stat-breakdown').textContent =
                    `${data.active} active, ${data.wins + data.losses + data.expired} completed`;

                const winRate = data.win_rate !== null ? `${data.win_rate}%` : 'N/A';
                document.getElementById('stat-winrate').textContent = winRate;
                document.getElementById('stat-winrate').className = 'value ' +
                    (data.win_rate >= 50 ? 'success' : data.win_rate !== null ? 'warning' : '');
                document.getElementById('stat-wins-losses').textContent =
                    `${data.wins} wins / ${data.losses} losses`;

                document.getElementById('stat-rr').textContent = data.avg_rr_ratio + ':1';

                // TP Hit Stats
                const totalHits = (data.tp1_hits || 0) + (data.tp2_hits || 0) + (data.tp3_hits || 0);
                document.getElementById('stat-tp-hits').textContent = totalHits;
                document.getElementById('stat-tp-breakdown').textContent =
                    `TP1: ${data.tp1_hits || 0} | TP2: ${data.tp2_hits || 0} | TP3: ${data.tp3_hits || 0}`;

                // Avg P&L per trade
                const avgPnl = data.avg_pnl_per_trade || 0;
                document.getElementById('stat-avg-pnl').textContent = (avgPnl >= 0 ? '+' : '') + avgPnl.toFixed(2) + '%';
                document.getElementById('stat-avg-pnl').className = 'value ' + (avgPnl >= 0 ? 'success' : 'danger');

                document.getElementById('stat-4h').textContent = data.total_4h_signals;
                document.getElementById('stat-24h').textContent = data.total_24h_signals;

                document.getElementById('last-updated').textContent =
                    'Updated ' + timeAgo(data.last_updated);
            } catch (error) {
                console.error('Failed to load dashboard stats:', error);
            }
        }

        // Load symbol performance table
        async function loadSymbolPerformance() {
            try {
                const response = await fetch(`${API_BASE}/public/dashboard/symbols`);
                const data = await response.json();

                const tbody = document.getElementById('symbol-table');
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-muted);">No data yet</td></tr>';
                    return;
                }

                tbody.innerHTML = data.map(row => `
                    <tr>
                        <td class="symbol">${row.symbol.replace('USDT', '')}</td>
                        <td>${row.total}</td>
                        <td>
                            <div class="winrate-bar">
                                <div class="bar">
                                    <div class="fill" style="width: ${row.win_rate || 0}%"></div>
                                </div>
                                <span class="percent">${row.win_rate !== null ? row.win_rate + '%' : 'N/A'}</span>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load symbol performance:', error);
            }
        }

        // Load recent signals table
        async function loadRecentSignals() {
            try {
                const response = await fetch(`${API_BASE}/public/dashboard/recent`);
                const data = await response.json();

                const tbody = document.getElementById('recent-table');
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-muted);">No signals yet</td></tr>';
                    return;
                }

                tbody.innerHTML = data.map(row => `
                    <tr>
                        <td class="symbol">${row.symbol.replace('USDT', '')}</td>
                        <td><span class="badge ${row.direction.toLowerCase()}">${row.direction}</span></td>
                        <td><span class="badge ${row.status}">${row.status.replace('_', ' ').toUpperCase()}</span></td>
                        <td>${row.risk_reward_ratio}:1</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load recent signals:', error);
            }
        }

        // Load and render chart
        async function loadPerformanceChart() {
            try {
                const response = await fetch(`${API_BASE}/public/dashboard/daily`);
                const data = await response.json();

                const ctx = document.getElementById('performance-chart').getContext('2d');

                if (performanceChart) {
                    performanceChart.destroy();
                }

                if (data.length === 0) {
                    ctx.font = '14px Inter';
                    ctx.fillStyle = '#6b7084';
                    ctx.textAlign = 'center';
                    ctx.fillText('No data available yet', ctx.canvas.width / 2, ctx.canvas.height / 2);
                    return;
                }

                performanceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => d.date),
                        datasets: [
                            {
                                label: 'Signals',
                                data: data.map(d => d.signals),
                                backgroundColor: 'rgba(99, 102, 241, 0.6)',
                                borderColor: 'rgba(99, 102, 241, 1)',
                                borderWidth: 1,
                                borderRadius: 4,
                            },
                            {
                                label: 'Wins',
                                data: data.map(d => d.wins),
                                backgroundColor: 'rgba(34, 197, 94, 0.6)',
                                borderColor: 'rgba(34, 197, 94, 1)',
                                borderWidth: 1,
                                borderRadius: 4,
                            },
                            {
                                label: 'Losses',
                                data: data.map(d => d.losses),
                                backgroundColor: 'rgba(239, 68, 68, 0.6)',
                                borderColor: 'rgba(239, 68, 68, 1)',
                                borderWidth: 1,
                                borderRadius: 4,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: '#a0a3b1',
                                    usePointStyle: true,
                                    padding: 20,
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'rgba(42, 45, 56, 0.5)',
                                },
                                ticks: {
                                    color: '#6b7084',
                                    maxRotation: 45,
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(42, 45, 56, 0.5)',
                                },
                                ticks: {
                                    color: '#6b7084',
                                    stepSize: 1,
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to load chart:', error);
            }
        }

        // Load feature importance chart
        async function loadFeatureImportance() {
            try {
                const response = await fetch(`${API_BASE}/public/dashboard/features`);
                const data = await response.json();

                // Update table
                const tbody = document.getElementById('feature-table');
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-muted);">No feature data yet (need completed signals)</td></tr>';
                    document.getElementById('feature-section').style.display = 'none';
                    return;
                }

                document.getElementById('feature-section').style.display = 'block';

                tbody.innerHTML = data.map(row => `
                    <tr>
                        <td class="symbol">${row.feature_name}</td>
                        <td style="color: var(--success);">${row.win_avg.toFixed(3)}</td>
                        <td style="color: var(--danger);">${row.loss_avg.toFixed(3)}</td>
                        <td>
                            <div class="winrate-bar">
                                <div class="bar">
                                    <div class="fill" style="width: ${row.win_rate || 0}%"></div>
                                </div>
                                <span class="percent">${row.win_rate !== null ? row.win_rate + '%' : 'N/A'}</span>
                            </div>
                        </td>
                    </tr>
                `).join('');

                // Render chart
                const ctx = document.getElementById('feature-chart').getContext('2d');

                if (featureChart) {
                    featureChart.destroy();
                }

                featureChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => d.feature_name),
                        datasets: [{
                            label: 'Importance Score',
                            data: data.map(d => d.importance_score),
                            backgroundColor: 'rgba(99, 102, 241, 0.7)',
                            borderColor: 'rgba(99, 102, 241, 1)',
                            borderWidth: 1,
                            borderRadius: 4,
                        }]
                    },
                    options: {
                        indexAxis: 'y',  // Horizontal bars
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false,
                            },
                            tooltip: {
                                callbacks: {
                                    afterLabel: function(context) {
                                        const d = data[context.dataIndex];
                                        return `Win Avg: ${d.win_avg.toFixed(3)}\nLoss Avg: ${d.loss_avg.toFixed(3)}\nSamples: ${d.signal_count}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(42, 45, 56, 0.5)',
                                },
                                ticks: {
                                    color: '#6b7084',
                                }
                            },
                            y: {
                                grid: {
                                    display: false,
                                },
                                ticks: {
                                    color: '#a0a3b1',
                                    font: {
                                        size: 11,
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to load feature importance:', error);
                document.getElementById('feature-section').style.display = 'none';
            }
        }

        // Load feature drift alerts
        async function loadFeatureDrift() {
            try {
                const response = await fetch(`${API_BASE}/public/dashboard/features/drift`);
                const data = await response.json();

                const tbody = document.getElementById('drift-table');
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--success);">No significant drift detected</td></tr>';
                    return;
                }

                tbody.innerHTML = data.map(row => `
                    <tr>
                        <td class="symbol">${row.feature_name}</td>
                        <td>${row.recent_avg.toFixed(3)}</td>
                        <td>${row.historical_avg.toFixed(3)}</td>
                        <td style="color: ${row.is_significant ? 'var(--danger)' : 'var(--warning)'}; font-weight: 600;">
                            ${row.drift_percent > 0 ? '+' : ''}${row.drift_percent.toFixed(1)}%
                            ${row.is_significant ? ' âš ' : ''}
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load feature drift:', error);
            }
        }

        // Load all data
        async function loadAllData() {
            await Promise.all([
                loadDashboardStats(),
                loadSymbolPerformance(),
                loadRecentSignals(),
                loadPerformanceChart(),
                loadFeatureImportance(),
                loadFeatureDrift(),
            ]);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadAllData();

            // Auto-refresh every hour
            setInterval(loadAllData, 3600000);
        });
    </script>
</body>
</html>
